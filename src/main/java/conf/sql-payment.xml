<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="payment">
	<resultMap id="payResult" type="payment">
		<result property="imp_uid" column="PAY_ID" />
		<result property="merchant_uid" column="IMPORT_ID" />
		<result property="paid_amount" column="PAY_AMOUNT" />
		<result property="apply_num" column="PER_NUM" />
		<result property="paid_at" column="PER_TIME" />
		<result property="name" column="NAME" />
		<result property="buyer_name" column="BUYER_NAME" />
		<result property="buyer_email" column="BUYER_EMAIL" />
		<result property="buyer_tel" column="BUYER_TEL" />
		<result property="buyer_addr" column="BUYER_ADDR" />
		<result property="buyer_postcode" column="BUYER_POSTCODE" />
	</resultMap>
	
	<sql id="criteria">  <!-- MyBatis는 sql태그를 이용해서 SQL의 일부를 별도로 보관하고, 필요한 경우에 include 시키는 형식으로 사용할 수 있다.-->	
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
<!-- 				String[] getTypeArr 에서 나온 typeArr 쓰는것임 -->
			<if test="type != null and keyword != null">
				<foreach item="type" collection="typeArr">
					<trim prefix="OR">
						<choose>
							<when test="type == 'T'.toString()">
								title like '%'||#{keyword}||'%'
							</when>
							<when test="type == 'C'.toString()">
								content like '%'||#{keyword}||'%'
							</when>
							<when test="type == 'W'.toString()">
								writer like '%'||#{keyword}||'%'
							</when>
						</choose>
					</trim>
				</foreach>
			</if>
		</trim>		    
	</sql>


	<insert id="insertPaymentSuccess">
		<![CDATA[
			INSERT INTO PAY_IMPORT(
				PAY_ID
				, IMPORT_ID
				, PAY_AMOUNT
				, PER_NUM
				, PER_TIME
				, NAME
				, BUYER_NAME
				, BUYER_EMAIL
				, BUYER_TEL
				, BUYER_ADDR
				, BUYER_POSTCODE
			) VALUES (
				#{imp_uid}
				, #{merchant_uid}
				, #{paid_amount}
				, #{apply_num}
				, #{paid_at}
				, #{name}
				, #{buyer_name}
				, #{buyer_email}
				, #{buyer_tel}
				, #{buyer_addr}
				, #{buyer_postcode}
			)
		]]>
<!-- 		insert into pay_import values(#{imp_uid}, #{merchant_uid}, #{paid_amount}, #{apply_num}, #{paid_at}) -->
	</insert>	
	
	<select id="retrieveBoardList" parameterType="map" resultType="map">
		<![CDATA[
			SELECT PAYMENT.NAME
				, PAYMENT.PER_TIME 
			FROM PAY_IMPORT PAYMENT 
			WHERE  1=1
			ORDER BY PAYMENT.PER_TIME DESC
		]]>
	</select>
	
	<select id="getListWithPaging" resultType="payment">
		<![CDATA[
		
		SELECT
		    NAME, PER_TIME
	    from(
		    SELECT /*+INDEX_DESC(pay_import pk_pay_import) */
		        ROWNUM rn, name, per_time
		    FROM pay_import
		    WHERE 
		]]>	
			<trim prefix="(" suffix=") AND " prefixOverrides="OR">
				<foreach item="type" collection="typeArr">
					<trim prefix="OR">
						<choose>
							<when test="type == 'T'.toString()">
								title like '%'||#{keyword}||'%'
							</when>
							<when test="type == 'C'.toString()">
								content like '%'||#{keyword}||'%'
							</when>
							<when test="type == 'W'.toString()">
								writer like '%'||#{keyword}||'%'
							</when>
						</choose>
					</trim>
				</foreach>
			</trim>		    
		<![CDATA[
			ROWNUM <= #{pageNum} * #{amount}
			)
		where RN > (#{pageNum} -1) * #{amount}
		]]>	
		    
	</select>
	
	<select id="getTotalCount" resultType="int">
		<![CDATA[
			select count(*) from pay_import 
			
			where 
		]]>
		<include refid="criteria"></include>
		<![CDATA[
			name = '정기구매1'
		]]>
	</select>
	
	
	
</mapper>
